containers:
  text:
    setup:
    - !Alpine v3.1
    - !Text
      /etc/shakespeare: |
          Sir, in my heart there was a kind of fighting
          That would not let me sleep.

  moretext:
    setup:
    - !Alpine v3.1
    - !Text
      /etc/shakespeare: |
          Sir, in my heart there was a kind of fighting
          That would not let me sleep.
    volumes:
      /etc: !Snapshot

  cache_dirs:
    setup:
    - !Alpine v3.1
    - !CacheDirs /var/cache: var-cache

  ensure_dir:
    setup:
    - !Alpine v3.1
    - !EnsureDir /var/lib/mount_point
    - !EnsureDir /var/lib/mount_point/subdir
    volumes:
      /var/lib/mount_point: !BindRW /vagga/root/tmp

  busybox:
    setup:
    - !Alpine v3.1

  printenv:
    setup:
    - !Alpine v3.1
    - !Sh env

  unzip:
    setup:
    - !Alpine v3.3
    - !EnsureDir /root/configs/1/config
    - !Text
      /root/configs/1/config/vagga.yaml: Hello there
    - !Unzip
      url: ./config.zip
      path: /root/configs/1
    - !Unzip
      url: ./config.zip
      path: /root/configs/2
      subdir: .
    - !Unzip
      url: ./config.zip
      path: /root/configs/3
      subdir: config
    - !Unzip
      url: ./config.zip
      path: /root/configs/4
      subdir: config/

  unzip-no-subdir:
    setup:
    - !Alpine v3.3
    - !Unzip
      url: ./config.zip
      path: /root/configs/
      subdir: ./config

  vagga:
    setup:
    - !Alpine v3.1
    - !Install [wget]
    # Download file to workdir specifically
    - !Download
      url: http://files.zerogw.com/vagga/vagga-0.4.0.tar.xz
      path: /work/vagga-0.4.0.tar.xz
    # To test unpacking local archives
    - !Tar
      url: ./vagga-0.4.0.tar.xz
      subdir: vagga
      path: /usr/lib/vagga


commands:
  two-lines: !Supervise
    children:
      second-line: !Command
        container: busybox
        run: |
          sleep 0.05
          echo world
          sleep 0.05
      first-line: !Command
        container: busybox
        run: |
          echo hello
          sleep 0.1

  tagged: !Supervise
    children:
      first: !Command
        container: busybox
        tags: [first_and_second, first_and_third]
        run: |
          echo hello
          sleep 0.2
      second: !Command
        container: busybox
        tags: [first_and_second]
        run: |
          sleep 0.05
          echo world
          sleep 0.15
      third: !Command
        container: busybox
        tags: [first_and_third, third_only]
        run: |
          sleep 0.1
          echo ":)"
          sleep 0.1

  one-kills-another: !Supervise
    children:
      dying: !Command
        container: busybox
        run: |
          echo hello
          sleep 0.1
          echo world
      hanging: !Command
        container: busybox
        run: |
          echo hello
          sleep 1
          echo world

  vagga: !Command
    container: vagga
    run: ["/usr/lib/vagga/vagga"]

  replace-shake: !Command
    container: moretext
    run: |
      echo 'nope' > /etc/shakespeare
      cat /etc/shakespeare
